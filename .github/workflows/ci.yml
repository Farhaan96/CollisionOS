name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18.x'
  JWT_SECRET: 'test-jwt-secret-for-ci'
  JWT_EXPIRES_IN: '1h'

jobs:
  # Lint and Format Check
  lint-and-format:
    name: 'Lint & Format Check'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint

    - name: Check Prettier formatting
      run: npm run format -- --check

  # Unit and Integration Tests
  test-unit-integration:
    name: 'Unit & Integration Tests'
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: ['16.x', '18.x', '20.x']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup test database
      run: |
        mkdir -p data
        touch data/collisionos-test.db

    - name: Run unit tests with coverage
      run: npm run test:coverage
      env:
        CI: true
        NODE_ENV: test
        DATABASE_URL: './data/collisionos-test.db'

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.node-version == '18.x'
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  # End-to-End Tests
  test-e2e:
    name: 'E2E Tests (Playwright)'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Setup test database
      run: |
        mkdir -p data
        cp data/collisionos.db data/collisionos-test.db || touch data/collisionos-test.db
        npm run db:migrate
        npm run db:seed

    - name: Run Playwright tests
      run: npm run test:playwright
      env:
        CI: true
        NODE_ENV: test
        DATABASE_URL: './data/collisionos-test.db'

    - name: Upload Playwright report
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  # Type Checking
  type-check:
    name: 'TypeScript Type Check'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript type checking
      run: npm run type-check
      continue-on-error: true # TypeScript may not be fully configured yet

  # Build Test
  build-test:
    name: 'Build Application'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build React application
      run: npm run build
      env:
        CI: false # Disable treating warnings as errors for now

    - name: Test build artifacts
      run: |
        ls -la build/
        test -f build/index.html
        test -d build/static

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: build/
        retention-days: 7

  # Security Audit
  security-audit:
    name: 'Security Audit'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: npm audit --audit-level high
      continue-on-error: true # Don't fail CI for audit issues initially

    - name: Run npm audit fix (dry run)
      run: npm audit fix --dry-run
      continue-on-error: true

  # Bundle Analysis (on main branch only)
  bundle-analysis:
    name: 'Bundle Size Analysis'
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build and analyze bundle
      run: npm run build:analyze
      env:
        CI: false

    - name: Upload bundle analysis
      uses: actions/upload-artifact@v3
      with:
        name: bundle-analysis
        path: build/static/js/*.js
        retention-days: 30

  # Test Results Summary
  test-summary:
    name: 'Test Results Summary'
    runs-on: ubuntu-latest
    needs: [lint-and-format, test-unit-integration, test-e2e, type-check, build-test, security-audit]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lint & Format | ${{ needs.lint-and-format.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Unit & Integration Tests | ${{ needs.test-unit-integration.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| E2E Tests | ${{ needs.test-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Type Check | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Test | ${{ needs.build-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Audit | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
        
        # Fail if critical tests failed
        if [[ "${{ needs.test-unit-integration.result }}" == "failure" ]] || [[ "${{ needs.build-test.result }}" == "failure" ]]; then
          echo "❌ Critical tests failed!"
          exit 1
        elif [[ "${{ needs.lint-and-format.result }}" == "failure" ]] || [[ "${{ needs.test-e2e.result }}" == "failure" ]]; then
          echo "⚠️ Some tests failed, but build can proceed"
        else
          echo "✅ All tests passed!"
        fi

# Workflow notifications
  notify:
    name: 'Notify Results'
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Notify on success
      if: needs.test-summary.result == 'success'
      run: |
        echo "✅ CI Pipeline completed successfully for main branch"
        echo "All tests passed and build is ready for deployment"

    - name: Notify on failure
      if: needs.test-summary.result == 'failure'
      run: |
        echo "❌ CI Pipeline failed for main branch"
        echo "Please check the failed jobs and fix the issues"
        exit 1