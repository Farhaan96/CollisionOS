# CollisionOS Schema Deployment Guide

## Overview
This guide provides step-by-step instructions for deploying the CollisionOS collision repair schema to Supabase.

## Prerequisites
- Supabase project created
- Supabase CLI installed (optional but recommended)
- Database access (via Supabase dashboard or CLI)

## Deployment Order

### Step 1: Foundation Schema
Deploy the foundation tables first:
```sql
-- File: supabase-migration/schema/01_initial_schema.sql
-- Creates: shops, users, customers, vehicles, vendors, parts, audit_trail
```

### Step 2: Jobs & Workflow Schema
Deploy the workflow management tables:
```sql
-- File: supabase-migration/schema/02_jobs_and_workflow.sql
-- Creates: jobs, job_updates, job_parts, job_labor, estimates, notifications
```

### Step 3: Collision Repair Schema
Deploy the collision repair specific tables:
```sql
-- File: supabase-migration/schema/20250928_01_collision_repair_schema.sql
-- Creates: bms_imports, insurance_companies, claims, repair_orders,
--          parts_orders, parts_order_items, estimate_line_items,
--          attachments, invoices
```

## Deployment Methods

### Method 1: Supabase Dashboard (Recommended for Development)
1. Open your Supabase project dashboard
2. Go to Database > SQL Editor
3. Copy and paste each schema file in order
4. Execute each script and verify completion

### Method 2: Supabase CLI (Recommended for Production)
```bash
# Initialize Supabase (if not already done)
supabase init

# Deploy migrations
supabase db reset          # Reset to clean state
supabase db push           # Deploy all migrations

# Or deploy individual files
psql -h localhost -p 54322 -U postgres -d postgres -f supabase-migration/schema/01_initial_schema.sql
psql -h localhost -p 54322 -U postgres -d postgres -f supabase-migration/schema/02_jobs_and_workflow.sql
psql -h localhost -p 54322 -U postgres -d postgres -f supabase-migration/schema/20250928_01_collision_repair_schema.sql
```

### Method 3: Node.js Script
```bash
# Use our deployment script
npm install
node scripts/deploy-collision-repair-schema.js
```

## Verification

After deployment, verify the schema:

```sql
-- Check all tables exist
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;

-- Verify collision repair tables specifically
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN (
    'bms_imports', 'insurance_companies', 'claims', 'repair_orders',
    'parts_orders', 'parts_order_items', 'estimate_line_items',
    'attachments', 'invoices'
);

-- Check foreign key relationships
SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
    AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY'
AND tc.table_name LIKE 'bms%' OR tc.table_name LIKE 'claims%' OR tc.table_name LIKE 'repair%' OR tc.table_name LIKE 'parts%';
```

## Next Steps

1. **Deploy BMS Ingestion Function**
   ```bash
   supabase functions deploy bms_ingest
   ```

2. **Seed Sample Data**
   ```bash
   npm run seed:bms
   ```

3. **Test BMS Integration**
   ```bash
   npm run test:bms
   ```

4. **Start Development**
   ```bash
   npm run dev
   ```

## Troubleshooting

### Common Issues

1. **Table already exists errors**
   - Solution: Each table creation uses `CREATE TABLE IF NOT EXISTS`
   - If needed, drop existing tables first

2. **Foreign key constraint failures**
   - Solution: Ensure foundation schema is deployed first
   - Check that referenced tables exist

3. **Permission errors**
   - Solution: Ensure you're using the service role key
   - Check that Row Level Security policies are configured

4. **Extension not found (uuid-ossp)**
   - Solution: Enable in Supabase dashboard under Database > Extensions

### Support

For issues or questions:
1. Check the validation script output: `node scripts/validate-collision-repair-schema.js`
2. Review deployment logs carefully
3. Refer to Supabase documentation
4. Check CollisionOS CLAUDE.md for project-specific guidance

## Schema Statistics

- **Total Tables**: 22 (13 foundation + 9 collision repair)
- **Total Enums**: 33 (27 foundation + 6 collision repair)
- **Foreign Key Dependencies**: 13
- **Indexes**: ~50 (optimized for collision repair queries)
- **Functions**: 2 (RO numbering, PO numbering)

---

*Generated by CollisionOS Migration Creator on 2025-09-28*
